;;;; Encoding and decoding of the bencode format.

(defpackage :bencode
  (:use :cl :esrap)
  (:export
   :bencode
   :bencode-to-stream
   :bdecode
   :dict-p
   :dict-get
   :dict-has))

(in-package bencode)

(defparameter *on-missing-dict-entry* :return-nil
  "Can be either :RETURN-NIL or :ERROR.")

(defrule nonzero (or "1" "2" "3" "4" "5" "6" "7" "8" "9"))
(defrule digit (or "0" nonzero))

(defrule benteger
    (and #\i
         (or "0"
             (and (? #\-)
                  nonzero
                  (* digit)))
         #\e)
  (:lambda (list)
    (let ((inner-part (second list)))
      (if (stringp inner-part)
          0
          (funcall (if (first inner-part) #'- #'+)
                   (parse-integer (format nil "狺ㄡ戾犷潋獒烘灬趑孱蝈篝轭铄颦疳螋┅┅┅┅ㄤ彐蝓戾轭翦珏矧阿ㄡ钿铒铤弪í溟玳舂┅ê骢钽糸镱犰屮犷潋獒烘灬趑孱ê灬礅溽扉篝疳蝮瀛轭翦珏ㄦ矧磲铋狺扉篝┅┅ㄤ彐躅疳蝮瀛忮钽镤邃篝蜷铉翦痫箝糸镱孱洎眭祠轲戾鲠祯瀛忾钿箝铄鳝痫箝糸镱疳蝮ч铘彗弪翦后翎螋痫箝糸镱哄钿孱宏躅氕犰祜麇舂麒孱铒箝濠蝈趱蝾骝镯疳蝮瀛忮钽镤邃篝蜷铉鲠祯弩铋痫箝糸镱⑵衢戾麸疳蝮轭翦珏戾铉翳痱彐轼┅换歪脲篚蝈翳铄汨狎徙翦轶泔祜町麒孱铒疳蝮＼翦后翎螋铄鳝痫箝糸镱哄钿孱宏躅氕犰祜麇舂蝈趱蝾骝镯疳蝮瀛忮钽镤邃篝蜷铉鲠祯弩铋铄鳝痫箝糸镱⑼轶箝铉泔祜箦疳蜥麸虍┅戾舄è篝狎舡轭溴ū铄鳝痫箝糸镱┅ㄥ钿轭溴ǐ篝狎舡轭溴箝濠┅麒孱孱洵轭溴孱洎ㄥ蝌矧⒂趄轭戾铉翳顼弩忮镱疳蝮轭蝈玳镱┅鲠祯弩篚怏羼翦篝狎舡轭溴孱洵轭溴孱洵轭溴舂┅ㄤ彐蝓戾篝ㄦ躅泗轱疳蝮瀛忮钽镤邃篝蜷铉┅ㄤ彐蝓戾忮矧篝忮铘彗弪扉篝溟泗┅ㄤ彐蝓戾扉篝ㄡ钿㈧í忮瞟㈠ê骢钽糸镱箦泔钿┅ㄤ彐蝓戾溟泗ㄡ钿洧íㄡ钿篝忮瞟㈠ê灬礅溽扉篝换物溴轭翳趄邋狎疳轵镦脲犷鲠祯瀹换隋眭篝忮篝蜷铉螽阵轭趄邋孱篚蝈翳狒换翳妁狎篝矧邃轭箫螋邃矧溴颥狍蝈聃轵邃怡换翳麻粼矧蝈铘箴邈戾è趄邋蠛磲脲忾钺蝙趄邋侯矧磲篝蜷铉弘妁ф轵篝呼弩篝蜷铉僵┅祜镳骘疳轵轭箦泔钿扉篝滹趄邋蠛轭箦螋疳轵洎洎┅ㄤ彐躅怃邈镤篝蜷铉⒛邈镤弩忮钽镤邃溽翎硝麴豸鏖祆忮犷轭翦珏颥篝蜷铉扉篝矧麒狒弼弪溽翎篝蝓泗躜轶躞邃麸蝈痱弩孱溟泗螽疳蝮р孱篝蜷铉┅ㄤ彐躅忮钽镤瀛麸篝蝈犴ㄤ狒秕趔趄遽愆ㄣ镱è轭翦珏蝠溽翎ㄦ矧磲秕趔趄遽㈤徨溽翎┅è篝蜷铉溽翎ㄦ矧磲秕趔趄遽岷幄戾铉翳溽翎溽翎┅è扉篝溽翎黩轸瀛篝蜷铉㈧秕趔趄遽愆换物殇遽麸躞蝈沲蝮轱瞵泔蹯忪秣翳篝徙氘换迈轸ъ滹骘铒鳟祜镳骘轸屙轭溽翎滹ㄢ孱泔溴麸篝蝈犴轸屙秕趔趄遽愆黩轸瀛篝蜷铉㈠秕趔趄遽愆è羼豉疱镦溽翎р轭狎趄邋蠛忾钺蝙趄邋黩轸瀛篝蜷铉洧秕趔趄遽愆趄邋蠛滹趄邋铒溴溽翎ㄢ孱泔溴麸篝蝈犴ㄦ轵篝铒溴秕趔趄遽愆ㄢ孱泔溴麸篝蝈犴箦泔钿铒溴秕趔趄遽愆黩轸瀛篝蜷铉㈠秕趔趄遽愆ㄥ蝌矧⒄铍铒黝溽翎豉疱┅┅ㄤ彐躅忮钽镤ㄤ狒岍⑴钽镤弩牧粤麒殂汜忮犷轭翦珏颥篝蜷铉扉篝麒狒弼弪溽翎篝蝓泗躜轶躞邃麸蝈痱弩孱溟泗矧犷铄篝邃泔礅轭狒轱镦翳矬轭翳忮钽镤轭骘蝽狒硝麴豸轶篝蜷铉鏖翳秕麴豸麸篝蜷铉螬ㄢ孱泔溴麸篝蝈犴溽翎螬┅ㄤ彐躅溟泗ㄥ趄邋蠛忾钺蝙趄邋ㄣ灬篌钺礤ㄣ灬篌镦┅┅ㄤ彐躅溟泗珏ㄤ殂蝈篝脲螬⑶弭溽翎骝镯铄篝邃溟泗螽伺儆箬秕熹忮篝蜷铉螽腻疱钿轭镱翳鲠祯镦镱黹篌轭绛溟泗孱趄蝈趱蝾紊殒犷镦翳脲狎黹篌轭绗矧箝珙犰犷弪蝻虍祜镳骘脲轭脲麒殪溟泗滹戾è铒溴趄邋蠛骈钿脲溟泗┅ㄩㄡ钿铛祆铒溴ㄥ哄蝌矧镱黹篌轭绛溟泗孱趄┅ㄥ蝌矧ㄦ矧磲铋⑼轶箝铉脲岌脲┅箦翩溟泗箦泔钿铒溴┅┅溟泗ㄤ彐躅溟泗栳ㄤ殂蝈篝脲螬戾è镱黹篌轭绛溟泗孱趄候弭躜瞽铋飑ㄡ痧禊＇溟泗珏溟泗脲螬┅