(defpackage :bencode
  (:use :cl :esrap))

(in-package bencode)

;; Test cases.
;;   1. i-0e is invalid.
;;   2. i03e is invalid.
;;   3. i0e is valid.
;;   4. i12e
;;   5. i-12e

(defrule nonzero (or "1" "2" "3" "4" "5" "6" "7" "8" "9"))
(defrule digit (or "0" nonzero))

(defrule benteger
    (and #\i
         (or "0"
             (and (? #\-)
                  nonzero
                  (* digit)))
         #\e)
  (:lambda (list)
    (let ((inner-part (second list)))
      (if (stringp inner-part)
          0
          (funcall (if (first inner-part) #'- #'+)
                   (parse-integer (format nil "狺ㄡ戾犷潋獒烘灬趑孱蝈篝轭铄颦疳螋┅┅┅┅ㄤ彐蝓戾轭翦珏矧阿ㄡ钿铒铤弪í溟玳舂┅ê骢钽糸镱犰屮犷潋獒烘灬趑孱ê灬礅溽扉篝疳蝮瀛轭翦珏ㄦ矧磲铋狺扉篝┅┅换轴扉篝蜷铉孱泔溟铉蠛换埠栝换昂换深鲠扉篝蜷铉孱泔溟铉蠛换茶换春栝换鸿ㄤ彐躅疳蝮瀛忮钽镤邃篝蜷铉翦痫箝糸镱孱洎眭祠轲戾鲠祯瀛忾钿箝铄鳝痫箝糸镱疳蝮ч铘彗弪翦后翎螋痫箝糸镱哄钿孱宏躅氕犰祜麇舂麒孱铒箝濠蝈趱蝾骝镯疳蝮瀛忮钽镤邃篝蜷铉鲠祯弩铋痫箝糸镱⑵衢戾麸疳蝮轭翦珏戾铉翳痱彐轼┅换歪脲篚蝈翳铄汨狎徙翦轶泔祜町麒孱铒疳蝮＼翦后翎螋铄鳝痫箝糸镱哄钿孱宏躅氕犰祜麇舂蝈趱蝾骝镯疳蝮瀛忮钽镤邃篝蜷铉鲠祯弩铋铄鳝痫箝糸镱⑼轶箝铉泔祜箦疳蜥麸虍┅戾舄è篝狎舡轭溴ū铄鳝痫箝糸镱┅ㄥ钿轭溴ǐ篝狎舡轭溴箝濠┅麒孱孱洵轭溴孱洎ㄥ蝌矧⒂趄轭戾铉翳顼弩忮镱疳蝮轭蝈玳镱┅鲠祯弩篚怏羼翦篝狎舡轭溴孱洵轭溴孱洵轭溴舂┅ㄤ彐蝓戾篝ㄦ躅泗轱疳蝮瀛忮钽镤邃篝蜷铉┅ㄤ彐蝓戾忮矧篝忮铘彗弪扉篝溟泗┅ㄤ彐蝓戾扉篝ㄡ钿㈧í忮瞟㈠ê骢钽糸镱箦泔钿┅ㄤ彐蝓戾溟泗ㄡ钿洧íㄡ钿篝忮瞟㈠ê骢钽糸镱箦泔钿┅